<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>What Affects Learning Gains?</title>
		<style>

		.A.dot{
			fill: #FFA500;
		}
		
		.B.dot{
			fill: #4169E1;
		}
		
		.A.correctbar{
			fill: #FFA500;
		}
		
		.B.correctbar{
			fill: #4169E1;
		}
		
		.A.incorrectbar{
			fill: #E9967A;
		}
		
		.B.incorrectbar{
			fill: #6A5ACD;
		}
		
		svg{
		}
		</style>
		<script src="d3.min.js"></script>
	</head>
<body>
<script>
/******************************************
Layout and appearance variables 
 ******************************************/
var graphHeight = 200, graphWidth = 200;
var problemSelectorHeight = 100;
var margin = {top: 50, right: 50, bottom: 50, left: 50};
var width = (7*graphWidth) + (8*margin.left), height = (2*graphHeight) + (3*margin.top) + 2*problemSelectorHeight;
var defaultRange = [0, graphWidth]; //for visual mapping, so should be same for all graphs?
var barWidth = 20;
var barMargin = {top: 10, right: 10, bottom: 10, left: 10};
/******************************************
Global(?) functions/variables - maybe put into their individual callbacks to prevent accidentally overwriting axes/scale info
 ******************************************/
 	//Holds data from CSV files
	var graphParams = [];
    var studentDataset = [];
    var problemsDataset = [];
    
    //the main SVG
    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)

	//y axis - should be the same for all graphs
	function addYAxis(elem){
		elem.append("g")
		  .attr("class", "y axis")
		  .call(yAxis)
		.append("text")
		  .attr("transform", "rotate(-90)")
		  .attr("y", 6)
		  .attr("dy", ".71em")
		  .style("text-anchor", "end")
		  .text("Learning Gains");
    }
    
    //TODO alter the range based on actual learning gains range?
	var y = d3.scale.linear()
		.domain([-20, 20])
		.range([200, 0]); //??

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left")
		.ticks(10, "");

/******************************
Map student data to graphs
******************************/	
	d3.csv("students.csv", function(data){

			//Assign loaded data to variables
			studentDataset = data.map(function(d){return d;});
			graphParams = d3.keys(data[0]).slice(7, 13); //only select the 6 parameters we want to make graphs for
			
			//Nest by condition (tablet, paper)
			var groups = d3.nest()
				 .key(function(d) { return d.Condition; })
				 .entries(data);
	
			console.log(groups);
			console.log(studentDataset);

			//Create a separate scale+axis for each parameter we care about
			d3.selectAll(groups)
				.each(function(d2, j){ 
					console.log(groups[j]);
					d3.selectAll(graphParams)
					.each(function(d, i) {
					
					//Container
					var holderX = margin.left+i*(graphWidth+2*margin.left);
					var holderY = j*(graphHeight+margin.top)+margin.top;
					var holder = svg.append("g")
						.attr("class", "graphHolder")
						.attr("width", graphWidth)
						.attr("height", graphHeight)
						.attr("transform", "translate(" + holderX + "," + holderY + ")");
				
					//X Scale
					var x = d3.scale.linear()
							.domain([0, d3.max(studentDataset, function(d) { return +d[graphParams[i]];} )])
							.range(defaultRange);
										
					//X Axis
					var xAxis = d3.svg.axis()
							.scale(x)
							.orient("bottom");
			
					holder.append("g")
							.attr("class", graphParams[i] + " x axis")
							.attr("transform", "translate(0," + graphHeight + ")")
							.call(xAxis)
						  .append("text")

							  .style("text-anchor", "start")
							  .text(graphParams[i]);
					//Y Axis
					addYAxis(holder);
			
					var dots = holder.selectAll("circle")
						.data(groups[j].values)
						.enter().append("circle")
							.attr("class", function(d) { return d.Unit2_PreTestType + " dot";})
							.attr("transform", function(d) { return "translate(" + x(+d[graphParams[i]]) + "," + y(+d["Learning Gains"]) + ")";})
							.attr("cy", 0)
							.attr("cx", 0)
							.attr("r", 2);
				});
		});	

});
/********************************
Map problem correctness data to bottom bar
********************************/
	//Container
	var barsholderX = margin.left;
	var barsholderY = (2*graphHeight) + (3*margin.top);
	var barsholder = svg.append("g")
		.attr("class", "barsHolder")
		.attr("width", width)
		.attr("height", problemSelectorHeight)
		.attr("transform", "translate(" + barsholderX + "," + barsholderY + ")");
		
    //TODO alter the range based on actual learning gains range?
	var barsY = d3.scale.linear()
		.domain([0, 1])
		.range([0, 100]); 

	var barsYAxis = d3.svg.axis()
		.scale(barsY)
		.orient("left")
		.ticks(2, "%");	
		
	//Y Axis, percentage
	barsholder.append("g")
		  .attr("class", "barsYAxis")
		  .call(barsYAxis)
		.append("text")
		  .attr("transform", "rotate(-90)")
		  .attr("y", 6)
		  .attr("dy", ".71em")
		  .style("text-anchor", "end")
		  .text("%");
    
d3.csv("problems.csv", function(data){
	problemsDataset = data.map(function(d){return d;});
	
	//Nest by type (A or B) - may need to do a nest for Unit also if we want to switch between those
	var groups = d3.nest()
		 .key(function(d) { return d.Type; })
		 .entries(data);
	
	//Default: map data for unit 2, pretest
	d3.selectAll(groups)
		.each(function(d2, j){ 
			//TODO how to get the incorrect bars showing too??
			var oneTypesBars = barsholder.append("g")
					.attr("class", "oneTypesBars")
					.attr("width", width)
					.attr("height", problemSelectorHeight)
			
			oneTypesBars.selectAll("rect")
				.data(groups[j].values)
				.enter()
				.append("rect") //correct
				  .attr("class", function(d) { return d.Type + " correctbar";})
				  .attr("x", function(d, i) { return (j*barWidth)+i*(barMargin.left+(graphWidth/3)); })
				  .attr("width", barWidth)
				  .attr("y", function(d){ return problemSelectorHeight - barsY(+d.NumCorrectPre/(+d.NumCorrectPre+(+d.NumIncorrectPre)));})
				  .attr("height", function(d) { return barsY(+d.NumCorrectPre/(+d.NumCorrectPre+(+d.NumIncorrectPre))); })	
					
			oneTypesBars.selectAll("rect")
				.data(groups[j].values)
				.enter()
				.append("rect") //incorrect
				  .attr("class", function(d) { return d.Type + " incorrectbar";})
				  .attr("x", function(d, i) { return (j*barWidth)+i*(barMargin.left+(graphWidth/3)); })
				  .attr("width", barWidth)
				  .attr("y", function(d) { return barsY(+d.NumCorrectPre/(+d.NumCorrectPre+(+d.NumIncorrectPre)))*problemSelectorHeight; }) //offset accordingly
				  .attr("height", function(d) { return barsY(+d.NumIncorrectPre/(+d.NumCorrectPre+(+d.NumIncorrectPre))); })					
		});		
	
	
});


</script>
</body>
</html>
