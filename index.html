<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>What Affects Learning Gains?</title>
		<style>

		.A.dot{
			fill: #FFA500;
		}
		
		.B.dot{
			fill: #4169E1;
		}
		
		.unknown.dot{
			fill: #000000;
		}
		
		.A.correctbar{
			fill: #FFA500;
		}
		
		.B.correctbar{
			fill: #4169E1;
		}
		
		.A.incorrectbar{
			fill: #DFCBA6;
		}
		
		.B.incorrectbar{
			fill: #D5D8E4;
		}
		
		svg{
		}
		</style>
		<script src="d3.min.js"></script>
	</head>
<body>
<script>
/******************************************
Layout and appearance variables 
 ******************************************/
var graphHeight = 200, graphWidth = 200;
var problemSelectorHeight = 100;
var margin = {top: 50, right: 50, bottom: 50, left: 50};
var width = (7*graphWidth) + (8*margin.left), height = (2*graphHeight) + (3*margin.top) + 2*problemSelectorHeight;
var defaultRange = [0, graphWidth]; //for visual mapping, so should be same for all graphs?
var barWidth = 15;
var barMargin = {top: 10, right: 10, bottom: 10, left: 10};
/******************************************
Global(?) functions/variables - maybe put into their individual callbacks to prevent accidentally overwriting axes/scale info
 ******************************************/
 	//Holds data from CSV files
	var graphParams = [];
    var studentDataset = [];
    var problemsDataset = [];
    
    //Default starting variables
    var CURRENT_UNIT = "2";
    var CURRENT_PREPOST= "Pre"; 
    
    //the main SVG
    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)

	//y axis - should be the same for all graphs
	function addYAxis(elem){
		elem.append("g")
		  .attr("class", "y axis")
		  .call(yAxis)
		.append("text")
		  .attr("transform", "rotate(-90)")
		  .attr("y", 6)
		  .attr("dy", ".71em")
		  .style("text-anchor", "end")
		  .text("Learning Gains");
    }
    
	var y = d3.scale.linear()
		.domain([-20, 20]) //default, is changed in callback
		.range([200, 0]);

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left")
		.ticks(10, "");

/******************************
Map student data to graphs
******************************/	
	d3.csv("students2.csv", function(data){

			//Assign loaded data to variables
			studentDataset = data.map(function(d){return d;});
			graphParams = d3.keys(data[0]).slice(14, 20); //only select the 6 parameters we want to make graphs for
			
			//Nest by condition (tablet, paper)
			var groups = d3.nest()
				 .key(function(d) { return d.Condition; })
				 .entries(data);

			//alter the range for Y axis
			y.domain(d3.extent(studentDataset, function(d) { return +d["Unit " + CURRENT_UNIT + " Learning Gain"];}));
			
			//Create a separate scale+axis for each parameter we care about
			d3.selectAll(groups)
				.each(function(d2, j){ 
					d3.selectAll(graphParams)
					.each(function(d, i) {
					
					//Container
					var holderX = margin.left+i*(graphWidth+2*margin.left);
					var holderY = j*(graphHeight+margin.top)+margin.top;
					var holder = svg.append("g")
						.attr("class", "graphHolder")
						.attr("width", graphWidth)
						.attr("height", graphHeight)
						.attr("transform", "translate(" + holderX + "," + holderY + ")");
				
					//X Scale
					var x = d3.scale.linear()
							.domain([0, d3.max(studentDataset, function(d) { return +d[graphParams[i]];} )])
							.range(defaultRange);
										
					//X Axis
					var xAxis = d3.svg.axis()
							.scale(x)
							.orient("bottom");
			
					holder.append("g")
							.attr("class", graphParams[i] + " x axis")
							.attr("transform", "translate(0," + graphHeight + ")")
							.call(xAxis)
						  .append("text")

							  .style("text-anchor", "start")
							  .text(graphParams[i]);
					//Y Axis
					addYAxis(holder);
			
					var dots = holder.selectAll("circle")
						.data(groups[j].values)
						.enter().append("circle")
							.attr("class", function(d) { 
									var t = d["Unit 2 Pre-Test Type"].toUpperCase();
									if(t == "A" || t == "B")
									return t + " dot";
									else
									return "unknown dot";
								})
							.attr("transform", function(d) { 
										var gains = d["Unit 2 Learning Gain"];
										var cat = +d[graphParams[i]];
										
										if(isNaN(gains) || isNaN(cat))
											return "translate(0,0)";
										else
											return "translate(" + x(cat) + "," + y(+gains) + ")";
									})
							.attr("opacity", function(d){ return (d["Unit " + CURRENT_UNIT + " Learning Gain"] == "null") ? 0 : 1;})
							.attr("cy", 0)
							.attr("cx", 0)
							.attr("r", 2);
				});
		});	

});
/********************************
Map problem correctness data to bottom bar
********************************/
	//Container
	var barsholderX = margin.left;
	var barsholderY = (2*graphHeight) + (3*margin.top);
	var barsholder = svg.append("g")
		.attr("class", "barsHolder")
		.attr("width", width)
		.attr("height", problemSelectorHeight)
		.attr("transform", "translate(" + barsholderX + "," + barsholderY + ")");
		
    //TODO alter the range based on actual learning gains range?
	var barsY = d3.scale.linear()
		.domain([1, 0])
		.range([100, 0]); 

	var barsYAxis = d3.svg.axis()
		.scale(barsY)
		.orient("left")
		.ticks(2, "%");	
		
	//Y Axis, percentage
	barsholder.append("g")
		  .attr("class", "barsYAxis")
		  .call(barsYAxis)
		.append("text")
		  .attr("transform", "rotate(-90)")
		  .attr("y", 6)
		  .attr("dy", ".71em")
		  .style("text-anchor", "end")
		  .text("%");
    
d3.csv("problems2.csv", function(data){
	problemsDataset = data.map(function(d){return d;});
	
	//Nest by Unit
	var groups = d3.nest()
		 .key(function(d) { return d.Unit; })
		 .key(function(d) { return d.Type; })
		 .entries(data);
	
	//Default: Unit 2 Pretest (alter CURRENT_PREPOST and CURRENT_UNIT to change what gets displayed)
	
	//Select all rows of current unit
	d3.selectAll(groups)
		.each(function(d2, k){ 
			if(this.key == CURRENT_UNIT){
				console.log(this);
				//Map A and B separately for 4 groups of bars: A-correct, A-incorrect, B-correct, B-incorrect 
				d3.selectAll(this.values)
					.each(function(dat, j){
						console.log(this);
						var correctBars = barsholder.append("g")
								.attr("class", "correctBars oneBarTypeHolder")
								.attr("width", width)
								.attr("height", problemSelectorHeight)
	
						var incorrectBars = barsholder.append("g")
								.attr("class", "incorrectBars oneBarTypeHolder")
								.attr("width", width)
								.attr("height", problemSelectorHeight)		

						//simplify selection for pre/post
						var corr = CURRENT_PREPOST + " Correct";
						var incorr = CURRENT_PREPOST + " Incorrect";					
						correctBars.selectAll("rect")
							.data(this.values)
							.enter()
							.append("rect") //correct
							  .attr("class", function(d) { return d.Type + " correctbar";})
							  .attr("x", function(d, i) { return (j*barWidth)+i*((graphWidth/4)); })
							  .attr("width", barWidth)
							  .attr("y", function(d){ return problemSelectorHeight - barsY(+d[corr]/(+d[corr]+(+d[incorr])));})
							  .attr("height", function(d) {return barsY(+d[corr]/(+d[corr]+(+d[incorr]))); })	
	
						incorrectBars.selectAll("rect")
							.data(this.values)
							.enter()
							.append("rect") //incorrect
							  .attr("class", function(d) { return d.Type + " incorrectbar";})
							  .attr("x", function(d, i) { return (j*barWidth)+i*((graphWidth/4)); })
							  .attr("width", barWidth)
							  .attr("y", 0)
							  .attr("height", function(d) { return barsY(+d[incorr]/(+d[corr]+(+d[incorr]))); });		
				   });
			}					
		});		
	
	
});


</script>
</body>
</html>
